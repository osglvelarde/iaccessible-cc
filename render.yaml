services:
  # Main Next.js Web Service
  - type: web
    name: iaccessible-cc
    env: node
    region: oregon  # Change to your preferred region
    plan: starter  # $7/month - includes persistent disk
    buildCommand: |
      # Install Python dependencies to project directory (persists to runtime)
      mkdir -p .python-packages
      # Use python3.11 if available, fallback to python3
      python3.11 -m pip install --target .python-packages -r requirements.txt 2>/dev/null || \
      python3 -m pip install --target .python-packages -r requirements.txt || \
      pip3 install --target .python-packages -r requirements.txt || \
      echo "Warning: Python dependencies may not have installed"
      # Verify installation
      python3.11 -m pip list --path .python-packages 2>/dev/null | grep uptime-kuma-api || \
      python3 -m pip list --path .python-packages | grep uptime-kuma-api || \
      echo "Warning: uptime-kuma-api not found"
      # Install Node.js dependencies
      pnpm install
      # Build Next.js app (using standard build for better Render compatibility)
      npm run build:standard || npm run build
    startCommand: |
      # Debug: Show current paths
      echo "=== RENDER PATH DEBUG ==="
      echo "Current directory (pwd): $(pwd)"
      echo "HOME: $HOME"
      echo "PYTHONPATH: $PYTHONPATH"
      echo "PYTHON_VERSION: $PYTHON_VERSION"
      echo "Python version: $(python3 --version 2>&1 || echo 'not found')"
      echo "========================="
      # Ensure .python-packages directory exists
      mkdir -p .python-packages
      echo "Created/verified .python-packages at: $(pwd)/.python-packages"
      # Set PYTHONPATH to include project packages directory
      export PYTHONPATH="${PYTHONPATH}:$(pwd)/.python-packages"
      echo "Updated PYTHONPATH: $PYTHONPATH"
      # Verify Python packages are available, install if missing
      echo "Checking for Python dependencies..."
      if ! python3 -c "import sys; sys.path.insert(0, '$(pwd)/.python-packages'); import uptime_kuma_api" 2>/dev/null; then
        echo "Python dependencies not found. Installing at runtime..."
        echo "Install location: $(pwd)/.python-packages"
        python3.11 -m pip install --target .python-packages -r requirements.txt 2>&1 || \
        python3 -m pip install --target .python-packages -r requirements.txt 2>&1 || \
        pip3 install --target .python-packages -r requirements.txt 2>&1
        # List what was installed
        echo "Contents of .python-packages after install:"
        ls -la .python-packages/ | head -20 || echo "Could not list directory"
        # Verify installation
        if python3 -c "import sys; sys.path.insert(0, '$(pwd)/.python-packages'); import uptime_kuma_api" 2>/dev/null; then
          echo "✓ Python dependencies installed successfully"
        else
          echo "✗ WARNING: Python dependencies installation may have failed"
          echo "Attempting to diagnose..."
          python3 -c "import sys; print('sys.path:', sys.path[:5])" 2>&1
        fi
      else
        echo "✓ Python dependencies already available"
      fi
      # Start Next.js application
      npm start
    envVars:
      # Uptime Kuma Configuration (Render Deployment)
      - key: UPTIME_KUMA_API_URL
        value: https://uptime-monitoring-tool.onrender.com
      - key: UPTIME_KUMA_USERNAME
        value: iaccessible-admin
      - key: UPTIME_KUMA_PASSWORD
        sync: false  # Set this manually in Render dashboard for security
      - key: UPTIME_KUMA_API_KEY
        value: uk1_ovykShADuMK42QsCudzJ_S2IjPl9AKAnHrDGEMzb
      # Node Environment
      - key: NODE_ENV
        value: production
      # Next.js Configuration
      - key: NEXT_PUBLIC_APP_URL
        generateValue: true  # Will be set to the service URL automatically
      # Python Configuration
      - key: PYTHON_VERSION
        value: "3.11.11"  # Explicit Python version for consistency
      - key: PYTHONPATH
        value: /opt/render/project/src/.python-packages:/opt/render/project/src:/usr/local/lib/python3.11/site-packages:/usr/lib/python3.11/site-packages
    # Persistent disk for file-based storage (users-roles-data, scanner-results, etc.)
    # Note: Disk must be created separately in Render Dashboard and linked to this service
    # Mount path will be configured when linking the disk
    # Recommended mount path: /opt/render/project/src/users-roles-data

